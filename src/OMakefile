

# USE_OCAMLFIND=true
# we don't depend on ocamlfind here

# OMakeFlags(--verbose)

## compile flags
OCAMLFLAGS = 
BYTE_ENABLED = true
NATIVE_ENABLED = true
OCAMLBIN_EXT = *.cmo *.cmi *.cmx *.cma *.cmxa *.cmxs *.run *.opt *.annot *.o

COMMON_INCLUDES[] =
    $(dir common)
TREEPARSER_INCLUDES[]=
    $(dir treeparser)
    $(COMMON_INCLUDES)
COLD_INCLUDES[]=
    $(dir cold)
    $(TREEPARSER_INCLUDES)
SRC_INCLUDES[]=
    $(dir src)
    $(TREEPARSER_INCLUDES)

NATIVE_ENABLED = true
FILES[] =
    # fan


COLD = fan

# hot preprocessed by cold
HOT_COLD = fan_hot_cold
# hot preprocessed by hot
HOT_HOT = fan_hot_hot




OCAML_OTHER_LIBS += dynlink
OCAML_LIBS[] =
    common/libcommon
    treeparser/libtreeparser
OCAML_LINK_FLAGS += -linkall    


.SUBDIRS: common treeparser

    
section
    .SUBDIRS: cold 
    OCAML_LIBS[] += cold/libcold
    OCamlProgram ($(COLD), $(FILES))

section
    VMOUNTDIR = _build/hot # simulate ocamlbuild to interact well with annotation
    vmount(-l,hot,$(VMOUNTDIR))
    PP_FAN = $(file $(COLD))
    .SUBDIRS: $(VMOUNTDIR)
    OCAML_LIBS[] += $(VMOUNTDIR)/libhot
    OCamlProgram($(HOT_COLD), $(FILES))

section
    vmount(-l,hot,hot3)
    PP_FAN = $(file $(HOT_COLD)) # use hot to preprocess hot
    .SUBDIRS: hot3
    OCAML_LIBS[] += hot3/libhot
    OCamlProgram($(HOT_HOT), $(FILES))
    
clean:
    rm -rf $(OCAMLBIN_EXT)

