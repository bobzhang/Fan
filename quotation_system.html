

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fan’s quosi-quotation &mdash; Fan 0.2 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Fan 0.2 documentation" href="index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="index.html" class="fa fa-home"> Fan</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="start.html">Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="start.html#installation">Installation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="philosophy.html">Overview of Fan&#8217;s architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="compilation.html">Command Line compilation Using Fan</a></li>
<li class="toctree-l1"><a class="reference internal" href="lexer.html">Lexer DDSL</a></li>
<li class="toctree-l1"><a class="reference internal" href="toplevel.html">Toplevel support</a></li>
<li class="toctree-l1"><a class="reference internal" href="browser.html">Fan in browser</a></li>
<li class="toctree-l1"><a class="reference internal" href="credits.html">Fan&#8217;s history</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Fan</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Fan&#8217;s quosi-quotation</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/quotation_system.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="fan-s-quosi-quotation">
<h1>Fan&#8217;s quosi-quotation<a class="headerlink" href="#fan-s-quosi-quotation" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>Fan&#8217;s quotation system</li>
</ul>
<p>Fan&#8217;s metaprogramming has a quotation system
[[<a class="reference external" href="http://brion.inria.fr/gallium/index.php/Quotation][similar">http://brion.inria.fr/gallium/index.php/Quotation][similar</a> to
Camlp4]].</p>
<p>The differences lie in serveral following aspects</p>
<p>*** Concrete Syntax</p>
<div class="highlight-python"><div class="highlight"><pre>- For quotation, Fan uses ~{:quot@loc| |}~, while Camlp4 uses ~&lt;:quot@&lt; &gt;&gt;~
- For antiquotation, Fan uses a single ~$~ or ~$(...)~, while Camlp4 uses ~$$~
- Fan supports nested quasiquotation, while Camlp4 does not.
  The following quotation is legal  in Fan.
  #+BEGIN_SRC ocaml
  {:exp|{:exp| $($x) |}|}
  #+END_SRC
  Which is simliar to Common Lisp style macros.
  #+BEGIN_SRC lisp
    ``(,,x)
  #+END_SRC
</pre></div>
</div>
<p>*** Abstract Syntax The definition of Fan&#8217;s abstract syntax is
available here <a class="reference external" href="file:fansrc/fAst.mli.html">file:fansrc/fAst.mli.html</a> Fan adopts polymorphic variants
for encoding abstract syntax, there are several major benefits</p>
<div class="highlight-python"><div class="highlight"><pre>- subtyping
  For user who wants to reuse part of Fan, the subtyping provides
  much more refined types
- constructor overloading
  There&#39;s no need to add a prefix for each type
- polymorphisim
  For example, in Fan, to get a location of an ast node, the user
  only need to write ~loc_of~, without writing ~loc_of_exp~,
  ~loc_of_pat~, /etc./ Other ast processing libraries are also
  more generic compared with Camlp4.
- unqualified, easier to use.

The disadvantage:
Error message is sometimes a problem, however, in Fan, the
default quasiquotation will add type annotation automatically for
the user, we have an optional quasiquotation without type
annotations for advanced user.

For example:

#+BEGIN_SRC ocaml
  (** with annotations *)
  {:exp|3|}
  (** after expansion *)
  (`Int (_loc, &quot;3&quot;) : FAst.exp )
  (** without annotations *)
  {:exp&#39;|3|}
  (** after expansion *)
  `Int (_loc, &quot;3&quot;)
#+END_SRC
</pre></div>
</div>
<p>**** location handling From the user&#8217;s point of view, Fan has two
abstract syntax representations, with or without locations. They have
exactly the same semantics except handling locations. The abstract
syntax without location is derived from abstract syntax with location.</p>
<div class="highlight-python"><div class="highlight"><pre>For example, the definition of ~literal~ (see [[file:fansrc/fAst.mli.html][fAst]]) are as follows:

#+BEGIN_SRC ocaml
  (** literal with locations [FAst]*)
  type literal =
    [ `Chr of (loc * string)
    | `Int of (loc * string)
    | `Int32 of (loc * string)
    | `Int64 of (loc * string)
    | `Flo of (loc * string)
    | `Nativeint of (loc * string)
    | `Str of (loc * string)]


  (** literal without locations [FAstN]*)
  type literal =
    [ `Chr of string
    | `Int of  string
    | `Int32 of  string
    | `Int64 of string
    | `Flo of string
    | `Nativeint of string
    | `Str of string]
  #+END_SRC
For ast without locations, the naming convention is a ~N~ postfix.
Programming abstract syntax without caring about locations is way
more easier. Location is important for debugging and meaningful
error message, however, some scenarios, for example, code
generation, don&#39;t need precise location.

There are serveral helpful functions for location handling

1. ~loc_of~
   it would fetch location from any type in module FAst
2. Objs.strip_[type]

   For example, Objs.strip_ctyp would strip the location for
   ctyp, their type signature are as follows: ([[https://github.com/bobzhang/ftop][ftop]] would help!)

   #+BEGIN_SRC ocaml
     utop $ Objs.strip_case;;
     - : FAst.case -&gt; FAstN.case = &lt;fun&gt;
     utop $ Objs.strip_exp;;
     - : FAst.exp -&gt; FAstN.exp = &lt;fun&gt;
   #+END_SRC
3. FanAstN.fill_[type]
   It&#39;s opposite to strip
   #+BEGIN_SRC ocaml
     utop $ FanAstN.fill_exp;;
     - : FLoc.t -&gt; FAstN.exp -&gt; FAst.exp = &lt;fun&gt;
     utop $ FanAstN.fill_case;;
     - : FLoc.t -&gt; FAstN.case -&gt; FAst.case = &lt;fun&gt;
   #+END_SRC

There is also a suite of quasiquotation for ast without locations.

#+BEGIN_SRC ocaml

  (** with annotations, [-] means minus locations *)
  {:exp-|3|}
  (** after expansion *)
  (`Int  &quot;3&quot; : FAstN.exp )

  (** without annotations *)
  {:exp-&#39;|3|}
  (** after expansion *)
  `Int  &quot;3&quot;
#+END_SRC
</pre></div>
</div>
</div>


          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Hongbo Zhang.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>