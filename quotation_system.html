
<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fan’s quosi-quotation &mdash; Fan 0.2 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Fan 0.2 documentation" href="index.html"/>
        <link rel="next" title="Fan in browser" href="browser.html"/>
        <link rel="prev" title="Parser DDSL" href="parser.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="index.html" class="icon icon-home"> Fan
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="start.html">Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="start.html#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="start.html#what-it-installed">What it installed?</a></li>
<li class="toctree-l3"><a class="reference internal" href="start.html#what-language-does-fan-speak">What language does Fan speak?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="philosophy.html">Overview of Fan&#8217;s architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="compilation.html">Command Line compilation Using Fan</a></li>
<li class="toctree-l1"><a class="reference internal" href="ddsl.html">DDSLs</a></li>
<li class="toctree-l1"><a class="reference internal" href="lexer.html">Lexer DDSL</a></li>
<li class="toctree-l1"><a class="reference internal" href="toplevel.html">Toplevel support</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Fan&#8217;s plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="parser.html">Parser DDSL</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Fan&#8217;s quosi-quotation</a></li>
<li class="toctree-l1"><a class="reference internal" href="browser.html">Fan in browser</a></li>
<li class="toctree-l1"><a class="reference internal" href="papers.html">Relevant papers</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev.html">Fan&#8217;s development guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="dev.html#build-system">Build system</a><ul>
<li class="toctree-l3"><a class="reference internal" href="dev.html#targets">Targets</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev.html#known-issues">Known issues</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="dev.html#test-its-correctness">Test its correctness</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="credits.html">Fan&#8217;s history</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Fan</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Fan&#8217;s quosi-quotation</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="https://github.com/bobzhang/fan/blob/master/docs/quotation_system.rst" class="fa fa-github"> Edit on GitHub</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="fan-s-quosi-quotation">
<h1>Fan&#8217;s quosi-quotation<a class="headerlink" href="#fan-s-quosi-quotation" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>Fan&#8217;s quotation system</li>
</ul>
<p>Fan&#8217;s metaprogramming has a <a class="reference external" href="http://brion.inria.fr/gallium/index.php/Quotation">Quotation system</a> similar to <a class="reference external" href="http://brion.inria.fr/gallium/index.php/Camlp4">Camlp4</a>.</p>
<p>The differences lie in serveral following aspects</p>
<ul>
<li><p class="first">Concrete Syntax</p>
<ul>
<li><p class="first">For quotation, Fan uses <code class="code docutils literal"><span class="pre">%quot&#64;loc{}</span></code>,
while Camlp4 uses <code class="code docutils literal"><span class="pre">&lt;:quot&#64;loc&lt;</span> <span class="pre">&gt;&gt;</span></code></p>
</li>
<li><p class="first">For antiquotation, Fan uses a single <code class="docutils literal"><span class="pre">$</span></code> or <code class="docutils literal"><span class="pre">${..}</span></code>, while
Camlp4 uses <code class="docutils literal"><span class="pre">$$</span></code></p>
</li>
<li><p class="first">Fan supports nested quasiquotation, while Camlp4 does not. For example,
the following quotation is legal  in Fan.</p>
<div class="highlight-ocaml"><div class="highlight"><pre><span class="o">%</span><span class="n">exp</span><span class="o">{</span> <span class="o">%</span><span class="n">exp</span><span class="o">{</span>  <span class="o">$($</span><span class="n">x</span><span class="o">)</span> <span class="o">}</span> <span class="o">}</span>
</pre></div>
</div>
<p>Which is simliar to Common Lisp style macros.</p>
<div class="highlight-lisp"><div class="highlight"><pre>``(,,x)
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
<blockquote>
<div></div></blockquote>
<ul>
<li><p class="first">Abstract Syntax Fan adopts polymorphic variants
for encoding abstract syntax, there are several major benefits</p>
<blockquote>
<div><ul class="simple">
<li>subtyping, for user who wants to reuse part of Fan, the
subtyping provides much more refined types</li>
<li>constructor overloading, there&#8217;s no need to add a prefix for each type</li>
<li>polymorphisim, for example, in Fan, to get a location of an ast
node, the user only need to write <code class="docutils literal"><span class="pre">loc_of</span></code>, without writing
<code class="docutils literal"><span class="pre">loc_of_exp</span></code>, <code class="docutils literal"><span class="pre">loc_of_pat</span></code>, <em>etc.</em> Other ast processing
libraries are also more generic compared with Camlp4.</li>
<li>unqualified, easier to use.</li>
</ul>
</div></blockquote>
<p>The disadvantage:</p>
<blockquote>
<div><p>Error message is sometimes a problem, however, in Fan, the
default quasiquotation will add type annotation automatically for
the user, we have an optional quasiquotation without type
annotations for advanced user.</p>
<p>For example:</p>
<blockquote>
<div><div class="highlight-ocaml"><div class="highlight"><pre><span class="c">(** with annotations *)</span>
<span class="o">%</span><span class="n">exp</span><span class="o">{</span> <span class="mi">3</span> <span class="o">}</span>
<span class="c">(** after expansion *)</span>
<span class="o">(`</span><span class="nc">Int</span> <span class="o">(_</span><span class="n">loc</span><span class="o">,</span> <span class="s2">&quot;3&quot;</span><span class="o">)</span> <span class="o">:</span> <span class="nn">FAst</span><span class="p">.</span><span class="n">exp</span> <span class="o">)</span>

<span class="c">(** without annotations *)</span>
<span class="o">%</span><span class="n">exp&#39;</span><span class="o">{</span><span class="mi">3</span><span class="o">}</span>
<span class="c">(** after expansion *)</span>
<span class="o">`</span><span class="nc">Int</span> <span class="o">(_</span><span class="n">loc</span><span class="o">,</span> <span class="s2">&quot;3&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</li>
<li><p class="first">Location handling</p>
<p>From the user&#8217;s point of view, Fan has two
abstract syntax representations, with or without locations. They
have exactly the same semantics except handling locations. The
abstract syntax without location is derived from abstract syntax
with location.  For example, the definition of <code class="docutils literal"><span class="pre">literal</span></code> are as
follows:</p>
<div class="highlight-ocaml"><div class="highlight"><pre><span class="c">(** literal with locations [FAst]*)</span>
<span class="k">type</span> <span class="n">literal</span> <span class="o">=</span>
  <span class="o">[</span> <span class="o">`</span><span class="nc">Chr</span> <span class="k">of</span> <span class="o">(</span><span class="n">loc</span> <span class="o">*</span> <span class="kt">string</span><span class="o">)</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Int</span> <span class="k">of</span> <span class="o">(</span><span class="n">loc</span> <span class="o">*</span> <span class="kt">string</span><span class="o">)</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Int32</span> <span class="k">of</span> <span class="o">(</span><span class="n">loc</span> <span class="o">*</span> <span class="kt">string</span><span class="o">)</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Int64</span> <span class="k">of</span> <span class="o">(</span><span class="n">loc</span> <span class="o">*</span> <span class="kt">string</span><span class="o">)</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Flo</span> <span class="k">of</span> <span class="o">(</span><span class="n">loc</span> <span class="o">*</span> <span class="kt">string</span><span class="o">)</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Nativeint</span> <span class="k">of</span> <span class="o">(</span><span class="n">loc</span> <span class="o">*</span> <span class="kt">string</span><span class="o">)</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Str</span> <span class="k">of</span> <span class="o">(</span><span class="n">loc</span> <span class="o">*</span> <span class="kt">string</span><span class="o">)]</span>


<span class="c">(** literal without locations [FAstN]*)</span>
<span class="k">type</span> <span class="n">literal</span> <span class="o">=</span>
  <span class="o">[</span> <span class="o">`</span><span class="nc">Chr</span> <span class="k">of</span> <span class="kt">string</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Int</span> <span class="k">of</span>  <span class="kt">string</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Int32</span> <span class="k">of</span>  <span class="kt">string</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Int64</span> <span class="k">of</span> <span class="kt">string</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Flo</span> <span class="k">of</span> <span class="kt">string</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Nativeint</span> <span class="k">of</span> <span class="kt">string</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Str</span> <span class="k">of</span> <span class="kt">string</span><span class="o">]</span>
</pre></div>
</div>
<p>For ast without locations, the naming convention is a <code class="docutils literal"><span class="pre">N</span></code> postfix.
Programming abstract syntax without caring about locations is way
more easier. Location is important for debugging and meaningful
error message, however, some scenarios, for example, code
generation, don&#8217;t need precise location.</p>
<p>There are serveral helpful functions for location handling</p>
<blockquote>
<div><ul>
<li><p class="first"><code class="docutils literal"><span class="pre">loc_of</span></code></p>
<blockquote>
<div><p>It would fetch location from any type in module FAst</p>
</div></blockquote>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">Objs.strip_[type]</span></code></p>
<blockquote>
<div><p>For example, Objs.strip_ctyp would strip the location for
ctyp, their type signature are as follows:</p>
<div class="highlight-ocaml"><div class="highlight"><pre><span class="n">utop</span> <span class="o">$</span> <span class="nn">Objs</span><span class="p">.</span><span class="n">strip_case</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="nn">FAst</span><span class="p">.</span><span class="n">case</span> <span class="o">-&gt;</span> <span class="nn">FAstN</span><span class="p">.</span><span class="n">case</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
<span class="n">utop</span> <span class="o">$</span> <span class="nn">Objs</span><span class="p">.</span><span class="n">strip_exp</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="nn">FAst</span><span class="p">.</span><span class="n">exp</span> <span class="o">-&gt;</span> <span class="nn">FAstN</span><span class="p">.</span><span class="n">exp</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">FanAstN.fill_[type]</span></code></p>
<blockquote>
<div><p>It&#8217;s opposite to strip</p>
<div class="highlight-ocaml"><div class="highlight"><pre><span class="n">utop</span> <span class="o">$</span> <span class="nn">FanAstN</span><span class="p">.</span><span class="n">fill_exp</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="nn">FLoc</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">FAstN</span><span class="p">.</span><span class="n">exp</span> <span class="o">-&gt;</span> <span class="nn">FAst</span><span class="p">.</span><span class="n">exp</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
<span class="n">utop</span> <span class="o">$</span> <span class="nn">FanAstN</span><span class="p">.</span><span class="n">fill_case</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="nn">FLoc</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">FAstN</span><span class="p">.</span><span class="n">case</span> <span class="o">-&gt;</span> <span class="nn">FAst</span><span class="p">.</span><span class="n">case</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>There is also a suite of quasiquotation for ast without locations.</p>
</div></blockquote>
</li>
</ul>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="browser.html" class="btn btn-neutral float-right" title="Fan in browser" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="parser.html" class="btn btn-neutral" title="Parser DDSL" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Hongbo Zhang.
    </p>
  </div>

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>